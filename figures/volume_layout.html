<!DOCTYPE html>
<html>
  <head>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/5.12.0/d3.min.js"></script>
      <script src="https://cdnjs.cloudflare.com/ajax/libs/flubber/0.4.2/flubber.min.js"></script>
      <script src="https://unpkg.com/d3-rect"></script>
      <script src="volgrammar-functions.js"></script>
  </head>
  <body>
    <div id="vis-volume-layout"></div>
    
    <script type="text/javascript">

        const svg = d3
            .select("#vis-volume-layout")
            .append("svg")
            .attr("viewbox", [-500, -300, 1000, 600]);

        var cfg = defaultconfig([12, 16], [
            [
                [-120.0, 120.0],
                [20.0, 200.0]
            ],
            [
                [-160.0, 160.0],
                [0.0, math.pi]
            ]
        ]);

        var celldatawithamr = createcells(cfg, 0, [12, 16], [0, 0], -400).concat(
            createcells(cfg, 1, [12, 16], [2, 4], -200)).concat(
            createcells(cfg, 2, [8, 8], [8, 10], 0)).concat(
            createcells(cfg, 2, [4, 6], [16, 32], 200));

        var pathcollection = createpaths(cfg, celldatawithamr);
        var cellsdisk = pathcollection

        var forwardint = [
            flubber.interpolateall(pathcollection.disk, pathcollection.memory),
            flubber.interpolateall(pathcollection.memory, pathcollection.cyl),
            flubber.interpolateall(pathcollection.cyl, pathcollection.disk)
        ];

        var reverseint = [
            flubber.interpolateall(pathcollection.memory, pathcollection.disk),
            flubber.interpolateall(pathcollection.cyl, pathcollection.memory),
            flubber.interpolateall(pathcollection.disk, pathcollection.cyl)
        ];

        function setup() {
            var cellColor = d3.scaleSequential(d3.interpolateSpectral)
                .domain([0, pathCollection.disk.length - 1]);
            svg.selectAll("path")
                .data(cellDataWithAMR)
                .enter()
                .append("path")
                .attr("stroke", "black")
                .attr("fill", (d, path_i) => cellColor(path_i))
                .attr("opacity", 0.75)
                .attr("d", (d, path_i) => pathCollection.disk[path_i]);
        }

        function transitionCells( interpolator) {
            svg.selectAll("path")
                .data(cellDataWithAMR)
                .transition()
                .delay(d => (d.flatIndex + 1) * 10)
                .duration(2000)
                .attrTween("d", function(d, path_i) {
                    return interpolator[path_i]
                });
        }

        var _transitions = [{
            transitionForward: () => setup(cellsDisk),
        }, {
            transitionForward: () => transitionCells(forwardInt[0]),
            transitionBackward: () => transitionCells(reverseInt[0]),
        }, {
            transitionForward: () => transitionCells(forwardInt[1]),
            transitionBackward: () => transitionCells(reverseInt[1]),
        }];

    </script>
  </body>
</html>
